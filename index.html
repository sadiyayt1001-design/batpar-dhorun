<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>বাটপার ধরুন</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body{font-family:sans-serif;background:#e8f5e9;margin:0;padding:0;}
.container{width:95%;max-width:500px;margin:10px auto;padding:10px;}
h1,h2{text-align:center;color:#212121;}
input,textarea{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:1px solid #ccc;}
button{padding:10px 15px;margin:5px 0;width:48%;border:none;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;}
button.login{background:#f44336;} button.register{background:#4caf50;} button.searchBtn{background:#388e3c;}
button.submit{background:#4caf50;} button.approve{background:#4caf50;} button.reject{background:#f44336;}
.postCard,.commentDiv{background:#fff;padding:10px;margin:8px 0;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
img{max-width:100%;border-radius:8px;margin-top:5px;}
#complaintsSection{display:none;}
</style>
</head>
<body>

<div class="container">
<h1>বাটপার ধরুন</h1>

<!-- User Registration/Login -->
<h2>Account তৈরি করুন / Login</h2>
<input type="text" id="userMobile" placeholder="মোবাইল নম্বর">
<input type="password" id="userPass" placeholder="Password">
<input type="text" id="userName" placeholder="নাম (Registration Only)">
<button class="register" onclick="registerUser()">Register</button>
<button class="login" onclick="loginUser()">Login</button>
<p id="currentUserDisplay"></p>
</div>

<div class="container" id="complaintsSection">

<h2>আপনার সাথে প্রতারণা হয়েছে?</h2>

<!-- Search Complaint -->
<input type="text" id="searchMobile" placeholder="মোবাইল নম্বর দিন (সার্চ)">
<button class="searchBtn" onclick="searchComplaints()">Search</button>

<div id="searchResults"></div>

<hr>

<!-- Submit Complaint -->
<h2>নতুন অভিযোগ দিন</h2>
<input type="text" id="cName" placeholder="নাম">
<input type="text" id="cMobile" placeholder="মোবাইল নম্বর">
<input type="text" id="cFraud" placeholder="প্রতারণার ধরন">
<input type="text" id="cTransaction" placeholder="Transaction / Payment">
<input type="file" id="cScreenshot">
<button class="submit" onclick="submitComplaint()">Submit Complaint</button>

<hr>

<!-- Bottom Section -->
<h2>বাটপার দের দেখুন</h2>
<div id="posts"></div>

</div>

<script>
  // ---------------- Firebase Config ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAIkxqhWez_3WzHwAVi3gzX5pS8oIWeQ9g",
    authDomain: "batpar-dhorun.firebaseapp.com",
    projectId: "batpar-dhorun",
    storageBucket: "batpar-dhorun.appspot.com",
    messagingSenderId: "301385643343",
    appId: "1:301385643343:web:dd79b7e751662e5620c13a",
    measurementId: "G-74H5JEMPN5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let currentUserId = null;
  let currentUserName = "";

  // ---------------- User Registration/Login ----------------
  function registerUser(){
    const mobile = document.getElementById('userMobile').value;
    const pass = document.getElementById('userPass').value;
    const name = document.getElementById('userName').value;
    if(!mobile || !pass || !name){alert("সব তথ্য দিন"); return;}
    db.collection('users').add({mobile,password:pass,name}).then(()=>{
      alert("Account তৈরি হয়েছে! Login করুন");
    });
  }

  function loginUser(){
    const mobile = document.getElementById('userMobile').value;
    const pass = document.getElementById('userPass').value;
    db.collection('users').where('mobile','==',mobile).where('password','==',pass)
      .get().then(snapshot=>{
        if(snapshot.empty){alert("Invalid Credentials"); return;}
        currentUserId = snapshot.docs[0].id;
        currentUserName = snapshot.docs[0].data().name;
        document.getElementById('currentUserDisplay').innerText = "Logged in as: "+currentUserName;
        document.getElementById('complaintsSection').style.display = "block";
        alert("Login Successful");
        loadAllPosts();
      });
  }

  // ---------------- Submit Complaint ----------------
  async function submitComplaint(){
    const name = document.getElementById('cName').value;
    const mobile = document.getElementById('cMobile').value;
    const fraud = document.getElementById('cFraud').value;
    const transaction = document.getElementById('cTransaction').value;
    const file = document.getElementById('cScreenshot').files[0];

    if(!name || !mobile || !fraud){alert("Name, Mobile, Fraud Type required"); return;}
    let fileURL = "";
    if(file){
      const storageRef = storage.ref("screenshots/"+Date.now()+"_"+file.name);
      await storageRef.put(file);
      fileURL = await storageRef.getDownloadURL();
    }

    db.collection("complaints").add({
      name, mobile, fraud_type:fraud, transaction, screenshot:fileURL,
      status:"pending", date:new Date()
    }).then(()=>{
      alert("Complaint Submitted! Waiting for Admin Approval");
      document.getElementById('cName').value="";
      document.getElementById('cMobile').value="";
      document.getElementById('cFraud').value="";
      document.getElementById('cTransaction').value="";
      document.getElementById('cScreenshot').value="";
    });
  }

  // ---------------- Search Complaints ----------------
  function searchComplaints(){
    const mob = document.getElementById('searchMobile').value;
    if(!mob){alert("মোবাইল নম্বর দিন"); return;}
    db.collection("complaints").where("mobile","==",mob).where("status","==","approved")
      .get().then(snapshot=>{
        const div = document.getElementById('searchResults');
        div.innerHTML = "";
        if(snapshot.empty){div.innerHTML="কোনও অভিযোগ পাওয়া যায়নি"; return;}
        snapshot.forEach(doc=>{
          const data = doc.data();
          const p = document.createElement('div');
          p.className="postCard";
          p.innerHTML = `<b>${data.name}</b> (${data.mobile})<br>
                         Fraud: ${data.fraud_type}<br>
                         Transaction: ${data.transaction}<br>
                         ${data.screenshot ? `<img src="${data.screenshot}">` : ""}`;
          div.appendChild(p);
        });
      });
  }

  // ---------------- Bottom Section (All Approved Posts) ----------------
  function loadAllPosts(){
    db.collection("complaints").where("status","==","approved")
      .orderBy("date","desc").onSnapshot(snapshot=>{
        const postsDiv = document.getElementById('posts');
        postsDiv.innerHTML="";
        snapshot.forEach(doc=>{
          const data = doc.data();
          const div = document.createElement('div');
          div.className="postCard";
          div.innerHTML = `<b>${data.name}</b> (${data.mobile})<br>
                           Fraud: ${data.fraud_type}<br>
                           Transaction: ${data.transaction}<br>
                           ${data.screenshot ? `<img src="${data.screenshot}">` : ""}`;
          postsDiv.appendChild(div);
        });
      });
  }

</script>
</body>
</html>
