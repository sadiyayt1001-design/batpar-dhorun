<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Batpar Dhorun</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body{font-family:sans-serif;margin:20px;}
input, textarea{width:100%;padding:8px;margin:5px 0;}
button{padding:10px 15px;margin-top:10px;cursor:pointer;}
#posts div, #adminPanel div{border:1px solid #ccc;padding:10px;margin:5px 0;}
#adminSection{display:none;border:1px solid #000;padding:10px;margin-top:20px;}
img{max-width:200px;margin-top:5px;}
.commentDiv{border-top:1px dotted #aaa;padding:3px;margin:3px 0;}
</style>
</head>
<body>

<h1>Batpar Dhorun</h1>

<!-- User Registration / Login -->
<h2>Register / Login</h2>
<input type="text" id="regName" placeholder="Name (for Registration)">
<input type="text" id="regMobile" placeholder="Mobile Number">
<input type="password" id="regPass" placeholder="Password">
<button onclick="registerUser()">Register</button>
<button onclick="loginUser()">Login</button>
<span id="currentUserDisplay"></span>

<hr>

<!-- Visitor Submit Complaint -->
<h2>Submit Complaint</h2>
<input type="text" id="name" placeholder="Name">
<input type="text" id="mobile" placeholder="Mobile Number">
<input type="text" id="address" placeholder="Address (optional)">
<input type="text" id="fraud_type" placeholder="Fraud Type">
<input type="text" id="transaction" placeholder="Transaction Method">
<input type="file" id="screenshot" accept="image/*">
<button onclick="submitComplaint()">Submit Complaint</button>

<hr>

<!-- Admin Login -->
<h2>Admin Login</h2>
<input type="text" id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">
<button onclick="adminLogin()">Login</button>

<!-- Admin Section -->
<div id="adminSection">
  <h2>Admin Panel (Pending Complaints)</h2>
  <div id="adminPanel"></div>
  <button onclick="logoutAdmin()">Logout</button>
</div>

<hr>

<!-- Public Posts -->
<h2>Approved Complaints</h2>
<div id="posts"></div>

<script>
  // ---------------- Firebase Config ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAIkxqhWez_3WzHwAVi3gzX5pS8oIWeQ9g",
    authDomain: "batpar-dhorun.firebaseapp.com",
    projectId: "batpar-dhorun",
    storageBucket: "batpar-dhorun.appspot.com",
    messagingSenderId: "301385643343",
    appId: "1:301385643343:web:dd79b7e751662e5620c13a",
    measurementId: "G-74H5JEMPN5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ---------------- User Accounts ----------------
  let currentUserId = null;
  let currentUserName = "";
  function registerUser(){
    const name = document.getElementById('regName').value;
    const mobile = document.getElementById('regMobile').value;
    const pass = document.getElementById('regPass').value;
    if(!name || !mobile || !pass){ alert("All fields required"); return; }
    db.collection('users').add({name, mobile, password:pass}).then(doc=>{
      alert('Registered! Now Login');
    });
  }
  function loginUser(){
    const mobile = document.getElementById('regMobile').value;
    const pass = document.getElementById('regPass').value;
    db.collection('users').where('mobile','==',mobile).where('password','==',pass)
      .get().then(snapshot=>{
        if(snapshot.empty){ alert('Invalid Credentials'); return; }
        currentUserId = snapshot.docs[0].id;
        currentUserName = snapshot.docs[0].data().name;
        document.getElementById('currentUserDisplay').innerText = "Logged in as: "+currentUserName;
        alert('Login Successful');
      });
  }

  // ---------------- Submit Complaint ----------------
  async function submitComplaint(){
    const name = document.getElementById('name').value;
    const mobile = document.getElementById('mobile').value;
    const address = document.getElementById('address').value;
    const fraud_type = document.getElementById('fraud_type').value;
    const transaction = document.getElementById('transaction').value;
    const file = document.getElementById('screenshot').files[0];
    if(!name || !mobile || !fraud_type){ alert("Name, Mobile and Fraud Type are required"); return; }

    let fileURL = "";
    if(file){
      const storageRef = storage.ref("screenshots/"+Date.now()+"_"+file.name);
      await storageRef.put(file);
      fileURL = await storageRef.getDownloadURL();
    }

    db.collection("complaints").add({
      name, mobile, address, fraud_type, transaction,
      screenshot: fileURL, status:"pending", date: new Date()
    }).then(()=>{
      alert("Complaint Submitted! Waiting for Admin Approval");
      document.getElementById('name').value="";
      document.getElementById('mobile').value="";
      document.getElementById('address').value="";
      document.getElementById('fraud_type').value="";
      document.getElementById('transaction').value="";
      document.getElementById('screenshot').value="";
    });
  }

  // ---------------- Admin Login ----------------
  function adminLogin(){
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    if(user === "tarikul" && pass === "2026583"){
      document.getElementById('adminSection').style.display="block";
      alert("Login Successful");
      loadAdminPanel();
    } else { alert("Invalid Credentials"); }
  }
  function logoutAdmin(){
    document.getElementById('adminSection').style.display="none";
    document.getElementById('username').value="";
    document.getElementById('password').value="";
  }

  // ---------------- Admin Panel ----------------
  function loadAdminPanel(){
    db.collection("complaints").where("status","==","pending").onSnapshot(snapshot=>{
      const panel = document.getElementById('adminPanel');
      panel.innerHTML="";
      snapshot.forEach(doc=>{
        const data = doc.data();
        const div = document.createElement('div');
        div.innerHTML = `
          <b>${data.name}</b> (${data.mobile})<br>
          Fraud: ${data.fraud_type} | Transaction: ${data.transaction}<br>
          <a href="${data.screenshot}" target="_blank">View Screenshot</a><br>
          <button onclick="approveComplaint('${doc.id}')">Approve</button>
          <button onclick="rejectComplaint('${doc.id}')">Reject</button>
        `;
        panel.appendChild(div);
      });
    });
  }
  function approveComplaint(id){ db.collection("complaints").doc(id).update({status:"approved"}); }
  function rejectComplaint(id){ db.collection("complaints").doc(id).delete(); }

  // ---------------- Public Posts ----------------
  function renderPost(postId, data){
    const div = document.createElement('div');
    div.innerHTML = `
      <b>${data.name}</b> (${data.mobile})<br>
      Fraud: ${data.fraud_type} | Transaction: ${data.transaction}<br>
      Address: ${data.address}<br>
      ${data.screenshot ? `<img src="${data.screenshot}">` : ""}<br>
      <button onclick="reactPost('${postId}','like')">Like</button>
      <button onclick="reactPost('${postId}','dislike')">Dislike</button>
      <span id="count_${postId}">üëç 0 | üëé 0</span><br>
      <input type="text" id="comment_${postId}" placeholder="Write comment">
      <button onclick="commentPost('${postId}')">Comment</button>
      <div id="comments_${postId}"></div>
    `;
    document.getElementById('posts').appendChild(div);
    updatePostCounts(postId);
    loadComments(postId);
  }

  db.collection("complaints").where("status","==","approved")
    .orderBy("date","desc")
    .onSnapshot(snapshot=>{
      const postsDiv = document.getElementById('posts');
      postsDiv.innerHTML="";
      snapshot.forEach(doc=>{
        renderPost(doc.id, doc.data());
      });
    });

  // ---------------- Like / Dislike ----------------
  function reactPost(postId, type){
    if(!currentUserId){ alert('Login First'); return; }
    const ref = db.collection('postInteractions').doc(postId+'_'+currentUserId);
    ref.set({postId, userId:currentUserId, type}, {merge:true}).then(()=>{ updatePostCounts(postId); });
  }
  function updatePostCounts(postId){
    db.collection('postInteractions').where('postId','==',postId).get().then(snapshot=>{
      let likes=0, dislikes=0;
      snapshot.forEach(doc=>{
        if(doc.data().type==="like") likes++;
        else if(doc.data().type==="dislike") dislikes++;
      });
      document.getElementById('count_'+postId).innerText = `üëç ${likes} | üëé ${dislikes}`;
    });
  }

  // ---------------- Comments ----------------
  function commentPost(postId){
    if(!currentUserId){ alert('Login First'); return; }
    const text = document.getElementById('comment_'+postId).value;
    if(!text) return;
    db.collection('comments').add({
      postId, userId: currentUserId, username: currentUserName, commentText: text, timestamp: new Date()
    }).then(()=>{
      document.getElementById('comment_'+postId).value = "";
      loadComments(postId);
    });
  }
  function loadComments(postId){
    db.collection('comments').where('postId','==',postId)
      .orderBy('timestamp','asc')
      .get().then(snapshot=>{
        const cDiv = document.getElementById('comments_'+postId);
        cDiv.innerHTML="";
        snapshot.forEach(doc=>{
          const c = doc.data();
          cDiv.innerHTML += `<div class="commentDiv"><b>${c.username}:</b> ${c.commentText}</div>`;
        });
      });
  }
</script>
</body>
</html>
